// Copyright 2022 Framework Computer
// SPDX-License-Identifier: GPL-2.0-or-later

#include QMK_KEYBOARD_H
#include "framework.h"


enum _layers {
  _BASE,
  _CAPS,
  _FN,
  _SFT,
  _CTRL
};

enum Custom_Keycode {
    RGB_STEP,
};

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
    /* ANSI/US RGB keyboard key location to LED Index (Zeroed Values)
     *
     *   row 1      ┌────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬──────┬────┬───────┐
     *    LED's 17  │  0, 1  │  2  │  3  │  4  │  5  │  6  │  7  │  8  │  9  │ 10  │ 11  │12, 13│ 14 │15, 16 │
     *   row 2      ├─────┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬───┴─┬──┴───────┤
     *    LED's 15  │ 17  │ 18  │ 19  │ 20  │ 21  │ 22  | 23  │ 24  │ 25  │ 26  │ 27  │ 28  │ 29  │  30, 31  │
     *   row 3      ├─────┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬───────┤
     *    LED's 15  │ 32, 33 │ 34  │ 35  │ 36  │ 37  │ 38  │ 39  │ 40  │ 41  │ 42  │ 43  │ 44  │ 45  │  46   │
     *   row 4      ├────────┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴───────┤
     *    LED's 16  │47, 48, 49│ 50  │ 51  │ 52  │ 53  │ 54  │ 55  │ 56  │ 57  │ 58  │ 59  │ 60  │  61, 62   │
     *   row 5      ├──────────┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴───────────┤
     *    LED's 17  │ 63, 64, 65  │ 66  │ 67  │ 68  │ 69  │ 70  │ 71  │ 72  │ 73  │ 74  │ 75  │76, 77, 78, 79│
     *              ├────────┬────┴─┬───┴──┬──┴───┬─┴─────┴─────┴─────┴────┬┴─────┼─────┼─────┴┬──────┬──────┤
     *   row 6      │        │      │      │      │                        │      │     │      │  95  │      │
     *   LED's 17   │ 80, 81 │  82  │  83  │  84  │ 85, 86, 87, 88, 89, 90 │  91  │ 92  │  93  ├──────┤  96  │
     *              │        │      │      │      │                        │      │     │      │  94  │      │
     *   TOTAL      └────────┴──────┴──────┴──────┴────────────────────────┴──────┴─────┴──────┴──────┴──────┘
     *    LED's: 97
     */

    /*
     *              ┌────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬───────┐
     *   14 keys    │ ESCAPE │Mute │VolDn│VolUp│Prevs│Play │Next │LghDn│LghUp│Sceen│Airpl│Print│ App │Delete │
     *              ├─────┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬───┴─┬──┴───────┤
     *   14 keys    │  `  │  1  │  2  │  3  │  4  │  5  │  6  │  7  │  8  │  9  │  0  │  -  │  =  │Backspace │
     *              ├─────┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬───────┤
     *   14 keys    │  Tab   │Q, q │W, w │E, e │R, r │T, t │Y, y │U, u │I, i │O, o │P, p │[, { │], } │ \, |  │
     *              ├────────┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴───────┤
     *   13 keys    │  Caps    │A, a │S, s │D, d │F, f │G, g │H, h │J, j │K, k │L, l │;, : │', " │    Enter  │
     *              ├──────────┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴──┬──┴───────────┤
     *   12 keys    │  Shift      │Z, z │X, x │C, c │V, v │B, b │N, n │M, m │,, < │., > │/, ? │       Shift  │
     *              ├────────┬────┴─┬───┴──┬──┴───┬─┴─────┴─────┴─────┴────┬┴─────┼─────┼─────┴┬──────┬──────┤
     *              │        │      │      │      │                        │      │     │      │  ↑   │      │
     *   11 keys    │Control │Functn│ GUI  │ Alt  │        SpaceBar        │ Alt  │Cntrl│  ←   ├──────┤   →  │
     *              │        │      │      │      │                        │      │     │      │  ↓   │      │
     *              └────────┴──────┴──────┴──────┴────────────────────────┴──────┴─────┴──────┴──────┴──────┘
     *   78 total
     */



    [_BASE] = LAYOUT(
        KC_ESC,    KC_MUTE,  KC_VOLD, KC_VOLU, KC_MPRV, KC_MPLY, KC_MNXT, KC_BRID, KC_BRIU, KC_SCRN, KC_AIRP, KC_PSCR, KC_MSEL, KC_DEL,
        KC_GRV,    KC_1,     KC_2,    KC_3,    KC_4,    KC_5,    KC_6,    KC_7,    KC_8,    KC_9,    KC_0,    KC_MINS, KC_EQL,  KC_BSPC,
        KC_TAB,    KC_Q,     KC_W,    KC_E,    KC_R,    KC_T,    KC_Y,    KC_U,    KC_I,    KC_O,    KC_P,    KC_LBRC, KC_RBRC, KC_BSLS,
        KC_CAPS,   KC_A,     KC_S,    KC_D,    KC_F,    KC_G,    KC_H,    KC_J,    KC_K,    KC_L,    KC_SCLN, KC_QUOT,          KC_ENT,
        MO(_SFT),  KC_Z,     KC_X,    KC_C,    KC_V,    KC_B,    KC_N,    KC_M,    KC_COMM, KC_DOT,  KC_SLSH,                   KC_RSFT,
        MO(_CTRL), MO(_FN),  KC_LGUI, KC_LALT,          KC_SPC,                    KC_RALT, KC_RCTL, KC_LEFT, KC_UP,   KC_DOWN, KC_RGHT
    ),

    [_CAPS] = LAYOUT(
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,          _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______,                   _______,
        _______,   _______,  _______, _______,          _______,                   _______, _______, _______, _______, _______, _______
    ),



    [_FN] = LAYOUT(
        _______,   KC_F1,    KC_F2,   KC_F3,   KC_F4,   KC_F5,   KC_F6,   KC_F7,   KC_F8,   KC_F9,   KC_F10,  KC_F11,  KC_F12,  KC_INS,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,          _______,
        _______,   RGB_STEP, QK_BOOT, _______, _______, _______, _______, _______, _______, _______, _______,                   _______,
        _______,   _______,  _______, _______,          RGB_TOG,                   _______, _______, KC_HOME, KC_PGUP, KC_PGDN, KC_END
    ),

    [_SFT] = LAYOUT(
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,          _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______,                   _______,
        _______,   _______,  _______, _______,          _______,                   _______, _______, _______, _______, _______, _______
    ),

    [_CTRL] = LAYOUT(
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,          _______,
        _______,   _______,  _______, _______, _______, _______, _______, _______, _______, _______, _______,                   _______,
        _______,   _______,  _______, _______,          _______,                   _______, _______, _______, _______, _______, _______
    ),
};


bool rgb_matrix_indicators_advanced_user(uint8_t led_min, uint8_t led_max) {

    if (layer_state_is(_BASE)) {
        {
            //         a =  0    1    2    3    4    5    6    7    8    9
            int KS0[]    = {0,   47,  50,  63,  66,  76,  83,  92,  93 };
            int KS1[]    = {47,  50,  63,  66,  76,  83,  92,  93,  97 };
            int a;
            int RED0[]   = {0,   255, 0,   255, 0,   255, 0,   255, 0  };
            int BLUE0[]  = {0,   0,   0,   0,   0,   0,   0,   0,   0  };
            int GREEN0[] = {255, 72,  255, 72,  255, 72,  255, 72,  255};
            for (a = 0; a < 9; a++) {
                led_min = KS0[a];
                led_max = KS1[a];
                for (uint8_t i = led_min; i < led_max; i++) {
                    HSV hsv = {0, rgb_matrix_get_sat(), rgb_matrix_get_val()};
                    RGB_MATRIX_INDICATOR_SET_COLOR(i, RED0[a] * hsv.v / 255, BLUE0[a] * hsv.v / 255, GREEN0[a] * hsv.v / 255);
                }
            }
        }

    } else if (layer_state_is(_CAPS)) {
        {
            //         a =  0    1    2    3    4    5    6    7    8
            int KS0[] =    {0,   34,  44,  47,  50,  59,  66,  73 };
            int KS1[] =    {34,  44,  47,  50,  59,  66,  73,  97 };
            int a;
            int RED0[]   = {60,  0,   60,  255, 0,   60,  0,   60 };
            int BLUE0[]  = {0,   255, 0,   0,   255, 0,   255, 0  };
            int GREEN0[] = {255, 255, 255, 0,   255, 255, 255, 255};
            for (a = 0; a < 8; a++) {
                led_min = KS0[a];
                led_max = KS1[a];
                for (uint8_t i = led_min; i < led_max; i++) {
                    HSV hsv = {0, rgb_matrix_get_sat(), rgb_matrix_get_val()};
                    RGB_MATRIX_INDICATOR_SET_COLOR(i, RED0[a] * hsv.v / 255, BLUE0[a] * hsv.v / 255, GREEN0[a] * hsv.v / 255);
                }
            }
        }

    } else if (layer_state_is(_FN)) {
        {
            //         a =  0    1    2    3    4    5    6    7    8
            int KS0[] =    {0,   2,   17,  82,  84,  85,  86,  93 };
            int KS1[] =    {2,   17,  82,  84,  85,  86,  93,  97 };
            int a;
            int RED0[]   = {60,  255, 60,  255, 60,  255, 60,  255};
            int BLUE0[]  = {0,   128, 0,   0,   0,   0,   0,   128};
            int GREEN0[] = {255, 0,   255, 0,   255, 0,   255, 0  };
            for (a = 0; a < 8; a++) {
                led_min = KS0[a];
                led_max = KS1[a];
                for (uint8_t i = led_min; i < led_max; i++) {
                    HSV hsv = {0, rgb_matrix_get_sat(), rgb_matrix_get_val()};
                    RGB_MATRIX_INDICATOR_SET_COLOR(i, RED0[a] * hsv.v / 255, BLUE0[a] * hsv.v / 255, GREEN0[a] * hsv.v / 255);
                }
            }
        }

    } else if (layer_state_is(_SFT)) {
        {
            //         a =  0    1    2    3    4    5    6    7    8    9    10   11   12   13   14   15
            int KS0[] =    {0,   17,  30,  34,  44,  47,  50,  59,  61,  63,  66,  73,  76,  80,  83 };
            int KS1[] =    {17,  30,  34,  44,  47,  50,  59,  61,  63,  66,  73,  76,  80,  82,  97 };
            int a;
            int RED0[]   = {60,  255, 60,  0,   255, 60,  0,   255, 60,  255, 0,   255, 255, 60,  60 };
            int BLUE0[]  = {0,   36,  0,   255, 36,  0,   255, 36,  0,   0,   255, 36,  0,   0,   0  };
            int GREEN0[] = {255, 0,   255, 255, 0,   255, 255, 0,   255, 0,   255, 0,   0,   255, 255};
            for (a = 0; a < 15; a++) {
                led_min = KS0[a];
                led_max = KS1[a];
                for (uint8_t i = led_min; i < led_max; i++) {
                    HSV hsv = {0, rgb_matrix_get_sat(), rgb_matrix_get_val()};
                    RGB_MATRIX_INDICATOR_SET_COLOR(i, RED0[a] * hsv.v / 255, BLUE0[a] * hsv.v / 255, GREEN0[a] * hsv.v / 255);
                }
            }
        }

    } else if (layer_state_is(_CTRL)) {
        {
            //         a =  0    1    2    3    4    5    6    7    8    9    10   11
            int KS0[] =    {0,   39,  44,  51,  52,  66,  72,  80,  82,  92,  93 };
            int KS1[] =    {39,  44,  51,  52,  66,  72,  80,  82,  92,  93,  97 };
            int a;
            int RED0[]   = {60,  255, 60,  255, 60,  255, 60,  255, 60,  255, 60 };
            int BLUE0[]  = {0,   40,  0,   40,  0,   40,  0,   0,   0,   0,   0  };
            int GREEN0[] = {255, 150, 255, 150, 255, 150, 255, 0,   255, 0,   255};
            for (a = 0; a < 11; a++) {
                led_min = KS0[a];
                led_max = KS1[a];
                for (uint8_t i = led_min; i < led_max; i++) {
                    HSV hsv = {0, rgb_matrix_get_sat(), rgb_matrix_get_val()};
                    RGB_MATRIX_INDICATOR_SET_COLOR(i, RED0[a] * hsv.v / 255, BLUE0[a] * hsv.v / 255, GREEN0[a] * hsv.v / 255);
                }
            }
        }
    }
    return false;
};

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    switch (keycode) {

        case RGB_STEP:
            if (record->event.pressed) {
                HSV     hsv   = rgb_matrix_get_hsv();
                uint8_t new_s = 0;
                uint8_t new_v = 0;
                if (hsv.s < 11) {
                    new_s = hsv.s + 1;
                } else if (hsv.s > 10) {
                    new_s = 0;
                };
                //            0    1    2    3    4    5    6    7   8   9   10
                int rgbv[] = {255, 230, 204, 178, 153, 128, 102, 77, 51, 26, 0};
                new_v      = rgbv[new_s];
                rgb_matrix_sethsv(0, new_s, new_v);
            }
            return true;

        case KC_CAPS: 
            if (record->event.pressed) {
                if (IS_LAYER_OFF(_CAPS)) {
                    layer_on(_CAPS);
                    return true;
                } else if (IS_LAYER_ON(_CAPS)) {
                    layer_off(_CAPS);
                    return true;
                }
            }
            return false;

        case MO(_SFT): 
            if (record->event.pressed) {
                if (layer_state_is(_BASE)) {
                    register_code(KC_LSFT);
                    return true;
                }
            } else {
                unregister_code(KC_LSFT);
                return true;
            }
            return false;

        case MO(_CTRL):
            if (record->event.pressed) {
                if (layer_state_is(_BASE)) {
                    register_code(KC_LCTL);
                    return true;
                }
            } else {
                unregister_code(KC_LCTL);
                return true;
            }
            return true;
    }

    return true;
}

